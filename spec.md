# Specification: Universal AI Bridge

## 1. Provider Injection (The "MetaMask" Pattern)

Instead of hardcoding an Extension ID, the extension injects a `window.ai` object into every webpage. This creates a standardized interface for any frontend.

---

## 2. API Reference

### `window.ai.getCapabilities()`

Returns the state of the AI environment so the frontend can adapt its UI.

* **Response Schema:**

```json
{
  "status": "ready",
  "providers": {
    "local": { "available": true, "models": ["llama3:8b", "phi3"] },
    "openAI": { "available": true, "models": ["gpt-4"] },
    "claude": { "available": true, "models": ["sonnet-4.5", "opus-4"] }, // It is listed because user has registered the API key to the extension, and specified the model to be used
  }
}

```

The application layer decide, from the list, what model can be used to deliver the website functionality.

### `window.ai.request()`

The primary method for execution. It supports **Intent-based** routing.

* **Payload:**

```json
{
  "method": "ai_generateText",
  "params": {
    "provider": "local",
    "model": "llama3:8b",
    "prompt": "Summarize this...",
    "max_tokens": 500
  }
}

```

---

## 3. Spending & History Feature

The extension maintains a local database (using `chrome.storage.local` or IndexedDB) to track every request. This is private to the user and never leaves their machine.

### A. History Data Structure

Each entry in the history should track:

* **Origin:** Which website made the request.
* **Model:** The specific model used (local or cloud).
* **Token Count:** Prompt vs. Completion tokens.
* **Cost:** Calculated based on the provider's rate (or $0 for local).

| Timestamp | Website | Model | Tokens | Est. Cost |
| --- | --- | --- | --- | --- |
| 2026-02-22 | my-app.com | GPT-4o | 1,200 | $0.018 |
| 2026-02-22 | local-dev.io | Llama 3 | 450 | $0.00 |


### B. User Cost Controls

The extension should allow users to set limits:

* **Max Daily Spend:** Auto-reject cloud requests if a website consume API costing exceed `$1.00/day`.
* **Cost Confirmation:** Always show a popup if an estimate exceeds `$0.05`.

### C. Chrome storage explanation

| Storage Type         | Best For                                    | Storage Limit (Chrome 2026)                   |
| -------------------- | ------------------------------------------- | --------------------------------------------- |
| chrome.storage.local | Settings, API keys, current status.         | 10 MB (Default) / Unlimited (with permission) |
| IndexedDB            | Spending History, large logs, chat history. | Up to 60% of free disk space                  |



---

## 4. Error Handling Model Management

Since models are heavy, the system must handle "missing" states gracefully.

| Error Code | Meaning | Suggested Frontend Action |
| --- | --- | --- |
| `MODEL_NOT_FOUND` | Model is not downloaded in Ollama. | Show "Download Llama3" link. |
| `INSUFFICIENT_FUNDS` | Cloud API balance is $0. | Redirect user to OpenRouter/Provider. |
| `USER_REJECTED` | User clicked "Deny" on the popup. | Stop loading spinner; notify user. |
| `HARDWARE_LIMIT` | System RAM is too low for the model. | Suggest a smaller model (e.g., Phi-3). |

---

## 5. Security Guardrails

1. **Approval Popup:** Just like a crypto transaction, every *first* request from a new domain must trigger a "Do you trust this site?" popup.
2. **Origin-Bound Keys:** API keys are stored in the extension's background script. The website **never** sees the key; it only sees the result.
3. **Local Isolation:** The extension should only connect to `localhost:11434` and never expose that port to the open web.

## 6. Development

### Project structure

- `extension/` : the actual chrome extension
- `sample/translation/` : the sample webapp (a app that translate a corpus to another language, side by side)
- `docs/` : the documentation for the project

### How to run the sample translation project

1. **Load the Extension**:
   - Open Chrome and go to `chrome://extensions/`
   - Enable "Developer mode"
   - Click "Load unpacked" and select the `extension/` folder
   - Copy the **Extension ID** generated by Chrome.

2. **Install and Run**:
   ```bash
   # In devkit/
   npm install

   # In sample/translation/
   npm install
   npm run dev
   ```


## 7. Task to be completed

### Phase 1: Chrome Extension Core (`extension/`)

- [x] Initialize project structure and Manifest V3 configuration (`manifest.json`, service worker entry, content script entry)
- [x] Background Service Worker: Ollama connection (`localhost:11434`) and request routing to local/cloud providers
- [x] Content Script: Inject `window.ai` object into every webpage (the "MetaMask" pattern)
- [x] Implement `window.ai.getCapabilities()` — query available providers and models
- [x] Implement `window.ai.request()` — intent-based routing (`ai_generateText`, etc.) with provider/model selection
- [x] Error handling: `MODEL_NOT_FOUND`, `INSUFFICIENT_FUNDS`, `USER_REJECTED`, `HARDWARE_LIMIT`

### Phase 2: Security & UI (`extension/`)

- [x] Approval Popup: first request from a new domain triggers a "Do you trust this site?" confirmation
- [x] Origin-Bound API Key management (keys stored in background service worker, never exposed to webpages)
- [x] Extension Popup UI: settings page for API key configuration and provider management
- [x] Local isolation: ensure Ollama connection is restricted to `localhost:11434` only

### Phase 3: Spending Tracking & Cost Controls (`extension/`)

- [ ] IndexedDB history storage (origin, model, token count prompt/completion, estimated cost per request)
- [ ] `chrome.storage.local` for settings, API keys, and current status
- [ ] Max Daily Spend control: auto-reject cloud requests when a site exceeds `$1.00/day`
- [ ] Cost Confirmation popup: prompt user approval when a single request estimate exceeds `$0.05`
- [ ] Popup UI: spending history dashboard (table with timestamp, website, model, tokens, cost)

### Phase 4: Devkit, Sample App & Documentation

- [ ] `devkit/`: npm package providing TypeScript type definitions and helper wrappers for `window.ai`
- [ ] `sample/translation/`: demo webapp — side-by-side corpus translation UI powered by the extension
- [ ] `docs/`: API reference, developer guide, and architecture overview